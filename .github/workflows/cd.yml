name: Deploy
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Connect and Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Stop execution on first error
            echo "Navigating to project directory..."
            cd /home/ubuntu/HNG-STAGE-3 || exit 1

            echo "Pulling latest code from GitHub..."
            git pull origin main || exit 1

            echo "Activating virtual environment..."
            source venv/bin/activate || exit 1

            echo "Installing dependencies..."
            pip install -r requirements.txt || exit 1

            echo "Restarting FastAPI service..."
            sudo systemctl restart fastapi || exit 1
            sudo systemctl status fastapi --no-pager --lines=10

            echo "Restarting Nginx..."
            sudo systemctl restart nginx || exit 1
            sudo systemctl status nginx --no-pager --lines=10
